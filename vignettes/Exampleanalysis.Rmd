---
title: "Example analysis"
author: 
- name: "Tingxi Long" 
date: "2022-12-08"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(plot.matrix)
```

### Introduction

In this part, I will perform an example data analysis with R with [@tidytuesday; @big_mtcars]. 

Objective: 

-   What is the diversity of schools in the United States? 
-   What is change in tuition cost for schools in the United States from 1985-2016?

Intended audience:

-   People who cares about quality of education. 
-   High school and college students
-   Parents and teachers are also potential audiences.

Link to original data:The two datasets for this part of the assignment comes from  [TidyTuesday](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-10-15).

### Get the data

```{r, message=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(here)
library(purrr)
```

::: {.callout-note}
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
:::

```{r, message=FALSE}
# Check if the data already exist
if(!dir.exists(here("data"))) { dir.create(here("data")) }

if(!file.exists(here("data","tuesdata_song.RDS"))){
  tuesdata <- tidytuesdayR::tt_load('2020-01-21')
  spotify_songs <- tuesdata$spotify_songs
    
  # save the files to RDS objects
  saveRDS(tuesdata$spotify_songs, file = here("data","tuesdata_song.RDS"))
}
```

Let's load the data
```{r, message=FALSE}
song<- readRDS(here("data","tuesdata_song.RDS"))
```

-   Here is a list of full [data dictionary](https://github.com/rfordatascience/tidytuesday/tree/master/data/2020/2020-01-21#readme) for what all the column names mean. 

### What genre of music is most suitable for dancing ?



```{r}
# 1 demonstrate purrr.
str_dat <- song |> 
  split(song$playlist_genre) |>
  map(.f = ~mean(.x$danceability))
str_dat
```
```{r}
song$temp_ener <- pmap_dbl(song,
                     .f = function(tempo, energy, ...){
                        tempo/energy
                     })
```

```{r}
songs_era <- song %>% 
  mutate(
    track_album_release_date = as.Date(track_album_release_date),
    year = as.numeric(format(track_album_release_date,'%Y')),
    era = case_when(year <= 2000 ~ "-2000",
                    year > 2000 & year <= 2010 ~ "00-10",
                    year > 2010 ~ "+2010"),
    duration_min = duration_ms/60000)
```

```{r}
songs_era %>%
  filter(!is.na(era)) %>%
  group_by(playlist_genre, era) %>%
  ggplot() +
  geom_boxplot(aes(era, track_popularity, fill=era), outlier.size=0) +
  facet_wrap(~playlist_genre,nrow = 3) + 
  labs(x='Era',y="popularity") +
  theme_minimal() +
  theme(legend.position = 'none')
```


```{r}
fig1 <-song %>%
  ggplot(aes(fill=playlist_genre,x=energy,y=loudness))+
  geom_bar(stat='identity')+ 
  labs(title ="Loudness of songs in relation to its energy index", subtitle = 
         "EDM has the largest loudness", caption = "Tingxi Long")
  + ylab("Loudness")+xlab("Energy index")
fig1
```

```{r}
# Select category=Asians.
songs_era %>%
  na.omit(era) %>%
  ggplot(aes(x=playlist_genre,y=duration_min)) +
  geom_violin(aes(fill=playlist_genre)) +
  facet_grid(~era) +
  theme_minimal() +
  labs(x='Duration (min)') +
  theme(legend.position = 'none')
```

```{r}
# 2. Plot the distribution
fig1<-ggplot(div, aes(x=n, y=fct_reorder(.f=state,.x=n))) + geom_bar(stat='identity')+theme_bw()+ labs(title ="States of the top 50 schools with highest percentage of Asian group", subtitle = "Florida and Texas has 8/50 schools from the 
top 50 schools with highest percentage of Asian group", caption = "Tingxi Long")+ ylab("State")+xlab("Number of schools")
fig1
```

```{r}
df <- diversity_school %>% 
  filter(freq != 0) %>%
  filter(category == "Black") %>%
  filter(str_detect(name, "University")==TRUE)%>%
  group_by(name) %>%
  arrange(desc(freq)) 
fig2a <-
  ggplot(head(df,25),aes(fill=state,x=freq,y=fct_reorder(.f=name, .x = freq)))+
  geom_bar(stat='identity')+xlab("proportion of black race")+ylab("School name")+
  labs(title ="Top 25 Universities with highest 
  percentage of Black group", subtitle = 
  "Louisiana and Mississippi has 4 schools listed in the top 25 Universities 
  with highest percentage of black group", caption = "Tingxi Long")
fig2a
fig2b <-
  ggplot(head(df,100),aes(fill=state,x=freq,y=fct_reorder(.f=state, .x = freq)))+
  geom_bar(stat='identity')+xlab("Number of universities")+ylab("State")+
  labs(title ="States of the top 100 schools with highest percentage of Black group", subtitle = 
  "Georgia has 9 Universities listed in the top 100 Universities 
  with highest percentage of black group", caption = "Tingxi Long")
fig2b
```


### What is the trend of tuition cost for colleges in the US?

Using the `hist_tution` data, find the 4-year constant tuition cost for private, public and all institutions from 1985-2016.

```{r}
# 1.  Add a column that just keeps the first `year`.
hist_tuition$in_year <- as.Date(as.character(substr(hist_tuition$year, 1, 4)), format = "%Y")
# 2.  Plot the trend 
ggplot(data=hist_tuition, aes(x=in_year, y = tuition_cost)) + 
  geom_line(aes(colour = type))+facet_wrap(.~tuition_type,nrow = 3)+
  labs(title ="Changes in tuition cost for different types of universities from 1985", 
       subtitle = "An increasing trend is observed among public and private instituions", caption = "Tingxi Long")+geom_point(aes(colour=type))+
  theme_classic()+theme(strip.background =element_rect(fill="azure2"))+
  scale_x_date(date_breaks = "5 years", date_minor_breaks = "2 years")+
  theme(axis.text.x = element_text(angle = -30, vjust = 0.5, hjust=0))+ylab("Cost of tuition (US dollor)")+xlab("Year")
```
```{r}
# demonstrate calculate_CI
tuition <- hist_tuition %>% 
  filter(type == "All Institutions") %>%
  filter(tuition_type == "All Constant")
CI<- calculate_CI(tuition$tuition_cost,conf=0.95)
CI
```

### Summary:

Among the top 50 schools where the percentage of Asians is arranged in a decreasing order, Florida and Texas has 8/50 schools from the top 50 schools with highest percentage of Asian group.

Among the top 25 Universities with highest percentage of Black group, Louisiana and Mississippi each has 4 schools in the list. 23 States has at least one University in the list of top 100 Universities with highest percentage of Black group.

The past 20 years have seen an increasing trend in tuition cost for both private and public colleges and universities.By the 2016, the tuition cost for 4-year program in private universities is almost twice the price of the tuition cost in public universities. The 95% Confidence interval for the all constant tuition cost for all institutions from 1985-2016 is (11617.93,25391.75)


``` {.r filename="Functions used in dplyr and tidyr and ggplot"}
dplyr::
  filter
  summarise
  group_by
  arrange
  mutate
forcats::
  fct_reorder
  fct_infreq
stringr::
  string_detect
ggplot:
  geom_boxplot
  geom_bar
  geom_violin
```


